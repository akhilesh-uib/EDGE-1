<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SGI Drought Explorer</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-sA+e2atLYH5H2G8pU5pKj9xX4MHDL/95B2S/bR5pTK0="
        crossorigin=""
    />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        h2 {
            text-align: center;
            margin: 10px 0;
        }

        #map {
            width: 100%;
            height: 90vh;
        }
    </style>
</head>

<body>

<h2>Sweden SGI Drought Characteristics</h2>
<div id="map"></div>

<!-- Leaflet JS (MUST come before your script) -->
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j8Mk0bNfX2YpWQb0pNi9E+9IY0p3pLtE6xA0F0M="
    crossorigin=""
></script>

<script>
    // -------------------------------
    // 1. Initialize map
    // -------------------------------
    const map = L.map("map").setView([60, 15], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // -------------------------------
    // 2. Load metadata + drought JSON
    // -------------------------------
    Promise.all([
        fetch("data/metadata.json").then(r => r.json()),
        fetch("data/drought_characteristics.json").then(r => r.json())
    ])
    .then(([metadata, droughts]) => {

        // -------------------------------
        // 3. Group droughts by station
        // -------------------------------
        const droughtByStation = {};

        droughts.forEach(d => {
            if (!droughtByStation[d.Station]) {
                droughtByStation[d.Station] = [];
            }
            droughtByStation[d.Station].push(d);
        });

        // -------------------------------
        // 4. Add markers
        // -------------------------------
        metadata.forEach(station => {

            const stationName = station.station_name;
            const lat = station.Latitude;
            const lon = station.Longitude;

            let popupHTML = `<b>${stationName}</b><br/>`;

            if (droughtByStation[stationName]) {
                popupHTML += "<hr/><b>Drought events:</b><br/>";

                droughtByStation[stationName].forEach(d => {
                    popupHTML += `
                        <div style="margin-bottom:6px;">
                            <b>Start:</b> ${d.Start}<br/>
                            <b>End:</b> ${d.End}<br/>
                            <b>Duration:</b> ${d.Duration_months} months<br/>
                            <b>Magnitude:</b> ${d.Magnitude}<br/>
                            <b>Lowest SGI:</b> ${d.Lowest_SGI}
                            (${d.Lowest_SGI_date})
                        </div>
                        <hr/>
                    `;
                });

            } else {
                popupHTML += "<i>No major drought events</i>";
            }

            L.circleMarker([lat, lon], {
                radius: 4,
                color: "darkred",
                fillColor: "red",
                fillOpacity: 0.7
            })
            .addTo(map)
            .bindPopup(popupHTML);
        });
    })
    .catch(err => {
        console.error("Error loading data:", err);
        alert("Failed to load JSON files. Check console.");
    });
</script>

</body>
</html>
