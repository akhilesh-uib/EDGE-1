<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Groundwater SGI Viewer</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Leaflet JS (MUST be before your script) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        h2 {
            padding: 10px;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        #info {
            padding: 10px;
        }

        #plot {
            height: 400px;
            width: 100%;
        }

        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 4px 8px;
            font-size: 14px;
        }
    </style>
</head>

<body>

<h2>Groundwater Standardized Index (SGI)</h2>

<div id="map"></div>
<div id="info"></div>
<div id="plot"></div>

<script>
    console.log("Script started");

    // ---------------- MAP ----------------
    const map = L.map("map").setView([60, 10], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    let droughtData = [];
    let sgiData = [];

    // ---------------- LOAD DROUGHT SUMMARY ----------------
    Papa.parse("data/drought_summary.csv", {
        download: true,
        header: true,
        complete: function (res) {
            console.log("Drought summary loaded:", res.data.length);
            droughtData = res.data;
        },
        error: function (err) {
            console.error("Drought summary error:", err);
        }
    });

    // ---------------- LOAD SGI TIME SERIES ----------------
    Papa.parse("data/sgi_timeseries.csv", {
        download: true,
        header: true,
        complete: function (res) {
            console.log("SGI time series loaded:", res.data.length);
            sgiData = res.data;
        },
        error: function (err) {
            console.error("SGI time series error:", err);
        }
    });

    // ---------------- LOAD METADATA & ADD MARKERS ----------------
    Papa.parse("data/metadata.csv", {
        download: true,
        header: true,
        complete: function (res) {
            console.log("Metadata loaded:", res.data.length);

            res.data.forEach(function (st) {
                if (!st.latitude || !st.longitude) return;

                const marker = L.circleMarker(
                    [parseFloat(st.latitude), parseFloat(st.longitude)],
                    {
                        radius: 6,
                        fillColor: "blue",
                        color: "black",
                        weight: 1,
                        fillOpacity: 0.8
                    }
                ).addTo(map);

                marker.on("click", function () {
                    showStation(st.station_name);
                });
            });
        },
        error: function (err) {
            console.error("Metadata error:", err);
        }
    });

    // ---------------- DISPLAY STATION DATA ----------------
    function showStation(stationName) {
        console.log("Clicked station:", stationName);

        // ---- Drought table ----
        const droughts = droughtData.filter(
            d => d.station_name === stationName
        );

        let html = `<h3>${stationName}</h3>`;

        if (droughts.length > 0) {
            html += `
                <table>
                    <tr>
                        <th>Start</th>
                        <th>End</th>
                        <th>Duration (months)</th>
                        <th>Magnitude</th>
                        <th>Min SGI</th>
                    </tr>
            `;

            droughts.forEach(d => {
                html += `
                    <tr>
                        <td>${d.start}</td>
                        <td>${d.end}</td>
                        <td>${d.duration_months}</td>
                        <td>${d.magnitude}</td>
                        <td>${d.lowest_sgi}</td>
                    </tr>
                `;
            });

            html += "</table>";
        } else {
            html += "<p>No drought summary available.</p>";
        }

        document.getElementById("info").innerHTML = html;

        // ---- SGI plot ----
        const series = sgiData.filter(
            s => s.station_name === stationName
        );

        const trace = {
            x: series.map(s => s.date),
            y: series.map(s => parseFloat(s.sgi)),
            mode: "lines",
            name: "SGI"
        };

        const layout = {
            title: `SGI Time Series – ${stationName}`,
            xaxis: { title: "Date" },
            yaxis: { title: "SGI" }
        };

        Plotly.newPlot("plot", [trace], layout);
    }
</script>

</body>
</html>
