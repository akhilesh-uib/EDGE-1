<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Groundwater SGI Viewer</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        #info {
            padding: 10px;
        }

        #plot {
            height: 400px;
            width: 100%;
        }
    </style>
</head>

<body>

<h2 style="padding:10px;">Groundwater Standardized Index (SGI)</h2>

<div id="map"></div>
<div id="info"></div>
<div id="plot"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    console.log("DOM loaded, Leaflet:", typeof L);

    // ---------------- MAP ----------------
    const map = L.map("map").setView([60, 10], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);

    let droughtData = [];
    let sgiData = [];

    // ---------------- LOAD DROUGHT SUMMARY ----------------
    Papa.parse("data/drought_summary.csv", {
        download: true,
        header: true,
        complete: res => droughtData = res.data
    });

    // ---------------- LOAD SGI ----------------
    Papa.parse("data/sgi_timeseries.csv", {
        download: true,
        header: true,
        complete: res => sgiData = res.data
    });

    // ---------------- LOAD METADATA ----------------
    Papa.parse("data/metadata.csv", {
        download: true,
        header: true,
        complete: function (res) {

            res.data.forEach(st => {
                if (!st.latitude || !st.longitude) return;

                const marker = L.circleMarker(
                    [parseFloat(st.latitude), parseFloat(st.longitude)],
                    { radius: 6, fillOpacity: 0.8 }
                ).addTo(map);

                marker.on("click", () => showStation(st.station_name));
            });
        }
    });

    function showStation(stationName) {

        const series = sgiData.filter(
            s => s.station_name === stationName
        );

        Plotly.newPlot("plot", [{
            x: series.map(s => s.date),
            y: series.map(s => parseFloat(s.sgi)),
            mode: "lines"
        }], {
            title: stationName,
            yaxis: { title: "SGI" }
        });
    }

});
</script>

</body>
</html>
