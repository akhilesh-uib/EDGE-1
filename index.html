<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EDGE-1: The European Dataset for Groundwater Drought Evaluation</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        h2 { padding: 10px; }

        #map { height: 450px; }

        #info {
            padding: 12px;
            border-top: 1px solid #ccc;
        }

        #sgi-container {
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }

        th {
            background: #f4f4f4;
        }
    </style>
</head>

<body>

<h2>EDGE-1: The European Dataset for Groundwater Drought Evaluation</h2>

<div id="map"></div>

<div id="info">
    <b>Click a station to see drought summary and SGI time series</b>

    <div id="sgi-container">
        <canvas id="sgi-chart"></canvas>

    <div id="drought-table"></div>
        
    </div>
</div>

<script>
let metadata, droughts, sgiData;
let sgiChart = null;
 
// --------------------------------------------------
// Load all data
// --------------------------------------------------
Promise.all([
    fetch("data/metadata.json").then(r => r.json()),
    fetch("data/drought_summary.json").then(r => r.json()),
    fetch("data/sgi_timeseries.csv").then(r => r.text())
]).then(data => {
    metadata = data[0];
    droughts = data[1];
    sgiData = parseCSV(data[2]);
    initMap()
});
    
function initMap() {
    // Europe bounding box (lat, lng): south, west, north, east
    const europeBounds = L.latLngBounds(
        [34, -25], // southwest: lat, lng
        [72, 45]   // northeast: lat, lng
    );

    // Create map centered on Europe
    const map = L.map("map", {
        // initial view roughly centered on central Europe
        center: [54, 10],
        zoom: 4,
        // prevent panning outside bounds
        maxBounds: europeBounds,
        // optional padding when the map bounces back to bounds
        maxBoundsViscosity: 0.8
    });

    // Fit the map to the Europe bounds on load (keeps the chosen zoom if already appropriate)
    map.fitBounds(europeBounds, { padding: [20, 20] });

    L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
            attribution: "© OpenStreetMap contributors",
            // you can set min/max zoom if you want to restrict zooming
            minZoom: 3,
            maxZoom: 12
        }
    ).addTo(map);

    // Optional: only add markers that lie inside the europeBounds
    metadata
        .filter(st => {
            // ensure coordinates are numeric
            const lat = parseFloat(st.Latitude);
            const lon = parseFloat(st.Longitude);
            return europeBounds.contains([lat, lon]);
        })
        .forEach(st => {

            const marker = L.circleMarker(
                [parseFloat(st.Latitude), parseFloat(st.Longitude)],
                { radius: 6, color: "blue" }
            ).addTo(map);

            marker.bindPopup(st.station_name);

            marker.on("click", () => {
                showDroughtSummary(st.station_name);
                plotSGI(st.station_name);
            });
        });
}
// --------------------------------------------------
// CSV parser
// --------------------------------------------------
function parseCSV(text) {
    const lines = text.trim().split("\n");
    const header = lines.shift().split(",");

    return lines.map(line => {
        const values = line.split(",");
        let obj = {};
        header.forEach((h, i) => obj[h] = values[i]);

        // IMPORTANT: lowercase 'sgi'
        obj.sgi = parseFloat(obj.sgi);

        return obj;
    });
}

// --------------------------------------------------
// Initialize map
// --------------------------------------------------
function initMap() {

    const map = L.map("map").setView([56, 14], 5);

    L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { attribution: "© OpenStreetMap contributors" }
    ).addTo(map);

    metadata.forEach(st => {

        const marker = L.circleMarker(
            [st.Latitude, st.Longitude],
            { radius: 6, color: "blue" }
        ).addTo(map);

        marker.bindPopup(st.station_name);

        marker.on("click", () => {
            showDroughtSummary(st.station_name);
            plotSGI(st.station_name);
        });
    });
}

// --------------------------------------------------
// Drought table
// --------------------------------------------------
function showDroughtSummary(station) {

    const dr = droughts.filter(d => d.Station === station);
    const container = document.getElementById("drought-table");

    if (dr.length === 0) {
        container.innerHTML =
            `<p><b>${station}</b>: No droughts detected.</p>`;
        return;
    }

    let html = `<h3>${station} – Drought Events</h3>`;
    html += `
        <table>
            <tr>
                <th>Start</th>
                <th>End</th>
                <th>Duration (months)</th>
                <th>Magnitude</th>
                <th>Lowest SGI</th>
                <th>Date of Lowest SGI</th>
            </tr>
    `;

    dr.forEach(d => {
        html += `
            <tr>
                <td>${d.Start}</td>
                <td>${d.End}</td>
                <td>${d.Duration_months}</td>
                <td>${d.Magnitude}</td>
                <td>${d.Lowest_SGI}</td>
                <td>${d.Lowest_SGI_date}</td>
            </tr>
        `;
    });

    html += `</table>`;
    container.innerHTML = html;
}

// --------------------------------------------------
// SGI time series plot
// --------------------------------------------------
function plotSGI(station) {

    const data = sgiData
        .filter(d => d.station_name === station)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    if (data.length === 0) {
        console.warn("No SGI data for station:", station);
        return;
    }

    const labels = data.map(d => d.date);
    const values = data.map(d => d.sgi);  // ← lowercase

    const ctx = document.getElementById("sgi-chart").getContext("2d");

    if (sgiChart) {
        sgiChart.destroy();
    }

    sgiChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Standardized Groundwater Index (SGI)",
                data: values,
                borderColor: "steelblue",
                borderWidth: 1.5,
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: "index",
                intersect: false
            },
            scales: {
                x: {
                    title: { display: true, text: "Date" }
                },
                y: {
                    title: { display: true, text: "SGI" },
                    suggestedMin: -3,
                    suggestedMax: 3
                }
            }
        }
    });
}
</script>
</body>
</html>
