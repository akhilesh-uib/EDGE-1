<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Groundwater SGI Viewer</title>

    <!-- Leaflet -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 50vh;
        }
        #info {
            padding: 10px;
        }
        #plot {
            height: 40vh;
        }
        table {
            border-collapse: collapse;
        }
        td, th {
            border: 1px solid #ccc;
            padding: 4px 8px;
        }
    </style>
</head>
<body>

<h2 style="padding:10px;">Groundwater Standardized Index (SGI)</h2>

<div id="map"></div>
<div id="info"></div>
<div id="plot"></div>

<script>
    const map = L.map("map").setView([60, 10], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    let droughtData = [];
    let sgiData = [];

    // Load drought summary
    Papa.parse("data/drought_summary.csv", {
        download: true,
        header: true,
        complete: function (res) {
            droughtData = res.data;
        }
    });

    // Load SGI time series
    Papa.parse("data/sgi_timeseries.csv", {
        download: true,
        header: true,
        complete: function (res) {
            sgiData = res.data;
        }
    });

    // Load metadata and build map
    Papa.parse("data/metadata.csv", {
        download: true,
        header: true,
        complete: function (res) {
            res.data.forEach(station => {
                if (!station.latitude || !station.longitude) return;

                const marker = L.circleMarker(
                    [station.latitude, station.longitude],
                    { radius: 6, fillColor: "blue", color: "black", fillOpacity: 0.8 }
                ).addTo(map);

                marker.on("click", () => showStation(station.station_name));
            });
        }
    });

    function showStation(stationName) {
        // --- Drought summary ---
        const droughts = droughtData.filter(
            d => d.station_name === stationName
        );

        let html = `<h3>${stationName}</h3>`;

        if (droughts.length > 0) {
            html += "<table><tr><th>Start</th><th>End</th><th>Duration (months)</th><th>Magnitude</th><th>Min SGI</th></tr>";
            droughts.forEach(d => {
                html += `<tr>
                    <td>${d.start}</td>
                    <td>${d.end}</td>
                    <td>${d.duration_months}</td>
                    <td>${d.magnitude}</td>
                    <td>${d.lowest_sgi}</td>
                </tr>`;
            });
            html += "</table>";
        } else {
            html += "<p>No drought summary available.</p>";
        }

        document.getElementById("info").innerHTML = html;

        // --- SGI time series ---
        const series = sgiData.filter(
            s => s.station_name === stationName
        );

        const trace = {
            x: series.map(s => s.date),
            y: series.map(s => parseFloat(s.sgi)),
            mode: "lines",
            name: "SGI"
        };

        const layout = {
            title: `SGI Time Series – ${stationName}`,
            xaxis: { title: "Date" },
            yaxis: { title: "SGI" }
        };

        Plotly.newPlot("plot", [trace], layout);
    }
</script>

</body>
</html>
